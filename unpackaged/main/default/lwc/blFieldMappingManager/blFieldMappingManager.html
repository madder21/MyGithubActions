<template>

  <div class="">

    <div class="field-mapping-header">

      <!-- select object \ profile -->
      <div class="combobox-container">

        <!-- use cases -->
        <lightning-combobox title="Select Use Case" label="Use Case" value={selectedUseCaseName}
          options={useCasesOptions} onchange={handleUseCaseSelect} class="usecase-combo">
        </lightning-combobox>
        <lightning-button-group class="btnGroup">
          <lightning-button label="Add Use Case" onclick={openNewUseCaseModal} icon-name="utility:add">
          </lightning-button>
          <lightning-button label="Edit" if:true={selectedUseCase} onclick={openUseCaseModal} title="Edit Use Case"
            icon-name="utility:edit" alternative-text="Edit"></lightning-button>
          <lightning-button label="Clone" name="cloneUsecase" if:true={selectedUseCase} onclick={openUseCaseModal} title="Clone Use Case"
            icon-name="utility:copy" alternative-text="Clone">
          </lightning-button>
        </lightning-button-group>


        <!-- profiles -->
        <lightning-combobox title="Select Profile" label="Profile" value={sprofile} options={profiles}
          onchange={handleChangeProfile}>
        </lightning-combobox>
        <button class="use-case-edit-btn slds-button slds-button_neutral slds-m-right_small" if:true={profilid}
          onclick={checkProfileAccess} title="Check Profile Access">
          <lightning-icon icon-name="utility:retail_execution" alternative-text="Check" size="xx-small">
          </lightning-icon>
        </button>

        <lightning-button-group class="btnGroup">
          <lightning-button label="Test Query" onclick={testQuery} icon-name="utility:connected_apps">
          </lightning-button>
          <lightning-button label="Import/Export" onclick={openImportModal} icon-name="utility:sort"></lightning-button>
        </lightning-button-group>

      </div>

      <div class="combobox-container">

        <div if:true={spinner} class="spinner-wrap" style="z-index: 9900;">
          <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
        </div>

      </div>

    </div>

    <!-- Field Mapping Data Table -->
    <div class="mapping-table">
      <lightning-button-group>

        <lightning-button label="Add Mapping" variant="neutral" onclick={openModalAdd} icon-name="utility:add">
        </lightning-button>

        <lightning-button label="Delete" variant="destructive" onclick={deleteSelected}
          icon-name="utility:delete"></lightning-button>

      </lightning-button-group>
      <div class="datatableWrapper">
        <lightning-datatable key-field="Id" data={fieldMappings} columns={colums} onrowaction={handleRowAction}
          sorted-by={sortedBy} sorted-direction={sortDirection} onsort={handleSort} show-row-number-column>
        </lightning-datatable>
      </div>
    </div>

    <lightning-button variant="brand" icon-name="utility:save" label="Save Use Case Mapping" onclick={saveMapping}>
    </lightning-button>

    <!-- Test Query Results-->
    <div class="slds-m-around_medium" if:true={testQueryResult.linesNum}>
      <p>
        <lightning-formatted-text value={testQueryResult.query}></lightning-formatted-text>
      </p>
      <div class="slds-grid" if:true={testQueryResult.queryResultSfJson}>
        <div class="slds-col">
          <textarea>{testQueryResult.queryResultSfJson}</textarea>
        </div>
        <div class="slds-col">
          <textarea>{testQueryResult.queryResultWrapperJson}</textarea>
        </div>
      </div>
    </div>


  </div>


  <!-- ============= Create/Update Field Mapping modal =================== -->
  <template if:true={displayModal}>
    <div class="mapping-update-form">
      <section role="dialog" class="slds-modal slds-fade-in-open slds-modal_medium">
        <div class="slds-modal__container">

          <header class="slds-modal__header">
            <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close"
              onclick={closeModal}>
              <lightning-icon icon-name="utility:close" size="medium"></lightning-icon>
              <span class="slds-assistive-text">Close</span>
            </button>
            <h2 class="slds-text-heading_medium slds-hyphenate">Object:
              {objectName}</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium modalContent" style="position: relative;">

            <div>
              <lightning-combobox name="UseCaseName" label="Use Case" class="hiddenField"
                value={fieldMappingRecord.UseCaseName} options={useCasesOptions} onchange={handleFormValueChange}
                disabled>
              </lightning-combobox>
            </div>
            <div class="slds-grid">
              <div class="slds-col">
                <lightning-combobox label="Field Name" class="mapping-form-input" value={fieldMappingRecord.SFFieldPath}
                  options={fieldOptions} required onchange={handleSfFieldSelect}>
                </lightning-combobox>

                <lightning-input name="SFFieldPath" class="mapping-form-input"
                  value={fieldMappingRecord.SFFieldPath} onchange={handleFormValueChange} onblur={setWrapperFieldName}>
                </lightning-input>
                <lightning-input name="SFLabel" class="mapping-form-input hiddenField"
                  value={fieldMappingRecord.SFLabel} onchange={handleFormValueChange}>
                </lightning-input>
              </div>
              <div class="slds-col col-right">
                <lightning-input name="Wrapper_Field_Name" label="Wrapper Field Name" class="mapping-form-input"
                  value={fieldMappingRecord.Wrapper_Field_Name} onchange={handleFormValueChange} required>
                </lightning-input>
              </div>
            </div>

            <div class="slds-m-top_medium">
              <div class="slds-grid">
                <div class="slds-col">
                  <lightning-input type="checkbox" name="Save_to_SF" label="Save To SF"
                    value={fieldMappingRecord.Save_to_SF} onchange={handleFormCheckboxChange}
                    checked={fieldMappingRecord.Save_to_SF}>
                  </lightning-input>
                  <lightning-input type="checkbox" name="Send_to_Clienteling_App" label="Save To Wrapper"
                    value={fieldMappingRecord.Send_to_Clienteling_App} onchange={handleFormCheckboxChange}
                    checked={fieldMappingRecord.Send_to_Clienteling_App}></lightning-input>
                </div>
                <div class="slds-col">
                  <lightning-input type="checkbox" name="GetPicklistLabel" label="Get Picklist Label"
                    value={fieldMappingRecord.GetPicklistLabel} onchange={handleFormCheckboxChange}
                    checked={fieldMappingRecord.GetPicklistLabel}></lightning-input>
                  <lightning-input type="checkbox" name="IsCurrency" label="Currency"
                    value={fieldMappingRecord.IsCurrency} onchange={handleFormCheckboxChange}
                    checked={fieldMappingRecord.IsCurrency}></lightning-input>
                  <lightning-input type="checkbox" name="Is_InnerSelect" label="Is Inner Select"
                    value={fieldMappingRecord.Is_InnerSelect} onchange={handleFormCheckboxChange}
                    checked={fieldMappingRecord.Is_InnerSelect}></lightning-input>
                </div>
              </div>
            </div>
            <div class="slds-m-top_medium" if:true={fieldMappingRecord.Is_InnerSelect}>
              <lightning-combobox name="InnerSelect_UseCase_DeveloperName" label="Inner Select Use Case"
                class="mapping-form-input" value={fieldMappingRecord.InnerSelect_UseCase_DeveloperName}
                options={useCasesOptions} onchange={handleFormValueChange}>
              </lightning-combobox>
            </div>

            <div if:true={modalSpinner} class="spinner-wrap">
              <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
            </div>
          </div>

          <footer class="slds-modal__footer">
            <lightning-button label="Cancel" variant="neutral" onclick={closeModal} class="slds-m-right_medium">
            </lightning-button>
            <lightning-button label="Save" variant="brand" onclick={saveFieldMappingRecord}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </div>
  </template>

  <!-- ============= Create/Update use case modal =================== -->
  <template if:true={displayUseCaseModal}>
    <div class="mapping-update-form">
      <section role="dialog" class="slds-modal slds-fade-in-open slds-modal_medium">
        <div class="slds-modal__container">

          <header class="slds-modal__header">
            <h2 id="modal-heading-02" class="slds-text-heading_medium slds-hyphenate">Use Case:
              {useCaseRecord.DeveloperName}</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium modal_usecase modalContent" style="position: relative;">
            <div class="slds-grid">
              <div class="slds-col">
                <lightning-input name="DeveloperName" label="Developer Name" value={useCaseRecord.DeveloperName}
                  onchange={handleUseCaseFormValueChange} disabled={useCaseRecord.Id} onblur={handleUseCaseDevNameBlur}>
                </lightning-input>
                <lightning-input name="Label" label="Label" value={useCaseRecord.Label}
                  onchange={handleUseCaseFormValueChange}></lightning-input>
              </div>
              <div class="slds-col col-right">
                <lightning-combobox name="ObjectName" label="Object" value={useCaseRecord.ObjectName}
                  options={objectOptions} onchange={handleUseCaseFormValueChange} class="">
                </lightning-combobox>

                <lightning-input name="ObjectName" label="&nbsp;" value={useCaseRecord.ObjectName} class="hiddenField">
                </lightning-input>

                <lightning-textarea name="Notes" value={useCaseRecord.Notes} onchange={handleUseCaseFormValueChange}
                  label="Notes"></lightning-textarea>
              </div>
            </div>


            <h2>Query Conditions</h2>

            <div class="slds-grid">
              <div class="slds-col">
                <lightning-combobox label="Query Field" name="QueryField" options={useCaseFieldOptions}
                  onchange={handleUseCaseFormValueChange}>
                </lightning-combobox>
              </div>

              <lightning-input label="Query Condition" name="QueryCondition" onchange={handleUseCaseFormValueChange}
                class="hiddenField">
              </lightning-input>
              <div class="">
                <lightning-button label="Copy to Clipboard" onclick={copyToClipboard} class="slds-button addQCBtn">
                </lightning-button>
              </div>
            </div>
            <lightning-textarea name="queryConditionText" value={queryConditionText}
              onchange={handleUseCaseFormValueChange} label="Query Condition Text"></lightning-textarea>

            <!-- <lightning-button-group>
              <lightning-button label="Add OR Group" name="or-group" variant="neutral" onclick={addGroup}
                icon-name="utility:add">
              </lightning-button>
              <lightning-button label="Add AND Group" name="and-group" variant="neutral" onclick={addGroup}
                icon-name="utility:add">
              </lightning-button>
              <lightning-button label="Delete" variant="destructive" onclick={deleteQueryconditions}
                icon-name="utility:delete"></lightning-button>
            </lightning-button-group>

            <div class="datatableWrapper">
              <lightning-tree-grid key-field="Id" data={useCaseConditions} columns={queryConditionColums}>
              </lightning-tree-grid>
            </div> -->

            <div if:true={modalSpinner} class="spinner-wrap">
              <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
            </div>
          </div>

          <footer class="slds-modal__footer">
            <div style="float:left;" if:true={useCaseRecord.Id}>
              <lightning-button label="Delete" variant="neutral" onclick={showConfirmDeleteUseCase}
                if:false={confirmDeleteUseCase}></lightning-button>
              <lightning-button label="Sure?" variant="destructive" onclick={deleteUseCase}
                if:true={confirmDeleteUseCase}></lightning-button>
            </div>
            <lightning-button label="Cancel" variant="neutral" onclick={closeUseCaseModal} class="slds-m-right_small">
            </lightning-button>
            <lightning-button label="Save" variant="brand" onclick={saveUseCaseRecord}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </div>
  </template>

  <!-- ============= confirm delete query condition modal =================== -->
  <template if:true={confirmDeleteQuerycondition}>
    <div class="mapping-update-form">
      <section role="dialog" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container">

          <header class="slds-modal__header">
            <h2 class="slds-text-heading_medium slds-hyphenate">Delete Conditions</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium">
            Are you sure you want to delete conditions?
          </div>

          <footer class="slds-modal__footer">
            <lightning-button label="Cancel" variant="neutral" onclick={closeConditionsConfirmModal}
              class="slds-m-right_small">
            </lightning-button>
            <lightning-button label="Ok" variant="brand" onclick={deleteQueryconditions}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </div>
  </template>


  <!-- ============= Field Mapping confirm delete modal =================== -->
  <template if:true={confirmDeleteSelected}>
    <div class="mapping-update-form">
      <section role="dialog" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container">

          <header class="slds-modal__header">
            <h2 class="slds-text-heading_medium slds-hyphenate">Delete Field Mapping</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium">
            Are you sure you want to delete {selectedRowsId.length} records?
          </div>

          <footer class="slds-modal__footer">
            <lightning-button label="Cancel" variant="neutral" onclick={closeConfirmModal} class="slds-m-right_small">
            </lightning-button>
            <lightning-button label="Ok" variant="brand" onclick={deleteSelected}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </div>
  </template>

  <!-- ============= Import/Export modal =================== -->
  <template if:true={displayImportModal}>
    <div class="mapping-update-form">
      <section role="dialog" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container">

          <header class="slds-modal__header">
            <h2 class="slds-text-heading_medium slds-hyphenate">Import / Export</h2>
          </header>

          <div class="slds-modal__content slds-p-around_medium" style="position: relative;">

            <textarea onchange={handleUseCaseJsonChange} onblur={handleUseCaseJsonChange}>{exportFieldsMapping}</textarea>
            <lightning-input type="checkbox" label="Automatically set field mapping names and labels"
              value={importAutoSetDevNames} onchange={handleImportCheckboxChange} checked={importAutoSetDevNames}>
            </lightning-input>

            <div if:true={modalSpinner} class="spinner-wrap">
              <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
            </div>
          </div>

          <footer class="slds-modal__footer">
            <!--div style="float:left;" if:true={useCaseRecord.Id}>
                <lightning-button label="Delete" variant="neutral" onclick={showConfirmDeleteUseCase} if:false={confirmDeleteUseCase}></lightning-button>
                <lightning-button label="Sure?" variant="destructive" onclick={deleteUseCase} if:true={confirmDeleteUseCase}></lightning-button>
              </div-->
            <lightning-button label="Cancel" variant="neutral" onclick={closeImportModal} class="slds-m-right_small">
            </lightning-button>
            <lightning-button label="Import" variant="brand" onclick={importUseCase}></lightning-button>
          </footer>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </div>
  </template>

</template>